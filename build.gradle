plugins {
    id "java"
    id "pmd"
    id "eclipse"
    alias(libs.plugins.gradle.versions)
    alias(libs.plugins.spotless) apply false
}

ext {
    schemasDir = file("config/triplea/schemas")
}

wrapper {
    distributionType = Wrapper.DistributionType.ALL
}

allprojects {
    apply plugin: "com.diffplug.spotless"
    apply plugin: "java"

    spotless {
        format "allFiles", {
            target "*"
            targetExclude "gradlew.bat"
            endWithNewline()
            leadingTabsToSpaces()
            trimTrailingWhitespace()
        }
    }
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

subprojects {
    apply plugin: "checkstyle"
    apply plugin: "jacoco"
    apply plugin: "java"
    apply plugin: "pmd"

    apply from: rootProject.file("gradle/scripts/release.gradle")
    apply from: rootProject.file("gradle/scripts/version.gradle")

    group = "triplea"

    ext {
        apacheHttpComponentsVersion = "4.5.14"
        assertjCoreVersion = '3.27.6'
        awaitilityVersion = "4.3.0"
        caffeineVersion = "3.2.3"
        checkstyleVersion = "8.45"
        commonsIoVersion = "2.21.0"
        commonsMathVersion = "3.6.1"
        commonsTextVersion = "1.15.0"
        dropwizardWebsocketsVersion = "1.3.14"
        equalsVerifierVersion = "4.2.5"
        feignVersion = "13.6"
        gsonVersion = "2.13.2"
        guavaVersion = "33.5.0-jre"
        hamcrestOptionalVersion = "2.0.0"
        hamcrestVersion = "2.0.0.0"
        jacksonDataTypeVersion = "2.20.1"
        jakartaMailVersion = "2.0.2"
        javaWebSocketVersion = "1.6.0"
        jaxbImplVersion = "4.0.6"
        jetbrainsAnnotationsVersion = "26.0.2-1"
        jlayerVersion = "1.0.1.4"
        junitJupiterVersion = "6.0.1"
        junitPlatformLauncherVersion = "6.0.1"
        logbackClassicVersion = "1.5.21"
        mockitoVersion = "5.21.0"
        openFeignVersion = "13.3"
        snakeYamlVersion = "3.0.1"
        sonatypeGoodiesPrefsVersion = "2.3.9"
        substanceVersion = "4.5.0"
        wireMockJunit5Version = "1.3.1"
        wireMockVersion = "3.0.1"
        xchartVersion = "3.8.8"
        xmlUnitCore = "2.11.0"
        xmlUnitMatchers = "2.11.0"
    }

    repositories {
        mavenCentral()
    }

    dependencies {
        implementation(libs.jlayer) {
            exclude group: 'junit', module: 'junit'
        }
        compileOnly(libs.lombok)
        annotationProcessor(libs.lombok)

        testCompileOnly(libs.lombok)
        testAnnotationProcessor(libs.lombok)

        implementation libs.logback.classic
        implementation libs.caffeine
        implementation libs.gson
        implementation libs.guava
        implementation libs.dropwizard.websockets
        implementation libs.jakarta.mail
        implementation libs.jaxb.impl
        implementation libs.commons.io
        implementation libs.feign.gson
        implementation libs.commons.math3
        implementation libs.commons.text
        implementation libs.apache.httpmime
        implementation libs.java.websocket
        implementation libs.jetbrains.annotations
        implementation libs.xchart
        implementation libs.radiance.substance
        implementation libs.snakeyaml.engine
        testImplementation libs.jackson.datatype.jsr310
        testImplementation libs.hamcrest.optional
        testImplementation libs.wiremock
        testImplementation libs.equals.verifier
        testImplementation libs.assertj.core
        testImplementation libs.awaitility
        testImplementation libs.hamcrest
        testImplementation libs.bundles.junit
        testImplementation libs.bundles.mockito
        testImplementation libs.sonatype.goodies.prefs
        testImplementation libs.bundles.xmlunit
        testImplementation libs.wiremock.junit5
        testRuntimeOnly libs.junit.jupiter.engine
        testRuntimeOnly libs.junit.platform.launcher
    }

    tasks.withType(JavaCompile).configureEach {
        options.compilerArgs += [
                "-Xlint:none,-processing"
        ]
        options.encoding = "UTF-8"
        options.incremental = true
    }

    tasks.withType(Test).configureEach {
        useJUnitPlatform() {}
        testLogging {
            exceptionFormat = "full"
            events = ["standardOut", "standardError", "skipped", "failed"]
        }
    }

    checkstyle {
        toolVersion = libs.versions.checkstyle.get()
        configFile = rootProject.file(".build/checkstyle.xml")
        configProperties = [samedir: configFile.parent]
    }

    checkstyleMain {
        maxWarnings = 0
        source sourceSets.main.output.resourcesDir
    }

    checkstyleTest {
        maxWarnings = 0
        source sourceSets.test.output.resourcesDir
        exclude "**/map-xmls/*.xml"
    }

    jacocoTestReport {
        reports {
            xml.required = true
            xml.outputLocation = project.layout.buildDir.file("jacoco.xml")
            html.required = true
        }
    }

    pmd {
        consoleOutput = true
        ruleSetFiles = files(rootProject.file(".build/pmd.xml"))
        ruleSets = []
        incrementalAnalysis = true
        toolVersion = libs.versions.pmd.get()
    }

    spotless {
        java {
            googleJavaFormat()
            removeUnusedImports()
        }
    }
}
